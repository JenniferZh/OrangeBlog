---
title: 程序员的自我修养——目标文件里有什么
date: 2020-01-30 23:06:57
tags:
- reading
- 程序员的自我修养
---

> 了不起的程序员对自己程序的每一个字节都了如指掌

## 目标文件的格式

windows和linux平台上的目标文件格式比较相似，都是COFF文件的变种
- PE (portable executable), linux平台
- ELF (executable linkable format), windows平台

## 目标文件的组成 (ELF)

ELF文件由一个HEADER，一系列表（段表，符号表等）和一系列段组成，这些段中，比较重要的有数据段、代码段。

> 为什么分开存放数据和代码？便于权限控制（代码只读，数据可读可写），内存节省（系统中存放改程序的副本时，代码段只需要存一份，数据段需要多份）

1. ELF Header
列举几个Header中比较重要的
- e_ident/OS，在哪个操作系统编译的
- e_machine，文件的CPU平台属性
- e_entry, 入口地址，加载完成后从哪里执行，.o文件里此值为0，存在于可执行文件
- e_shoff，段表在文件中的偏移

2. 段表
通过ELF Header即可找到段表，段表记录了每个段的段名，长度，位置，读写权限，通过段表查找
- sh_name:段名
- sh_size:段大小
- sh_offset:段在文件中的偏移
- sh_addr:如果这个段可以被加载，即为加载后在虚拟地址空间中的地址

3. 代码段 (.text)

4. 数据段 (.data)
存放已经**初始化了**的**全局变量**和**局部静态变量**

5. BSS段 (.bss)
存放**未初始化**的**全局变量**和**局部静态变量**

> C语言中的全局变量，全局静态变量，局部变量，局部静态变量
> 全局变量，全局作用域，可以被其他模块引用，在.data或者.bss段里
> 全局静态变量，只能作用于本文件，在.data或者.bss里
> 局部变量，仅在函数执行时有效，在栈里
> 局部静态变量，从程序开始到结束一直存在，区别是仅在本函数里可见

6. 重定位表 (.text.rel / .data.rel)

7. 符号表 (.symtab)
在链接中，**函数和变量**统称为符号(Symbol)，函数名和变量名是符号名(Symbol Name)，符号值就是他们的地址(Symbol Value)，符号是连接过程的粘合剂。一个目标文件的符号表中既有内部定义的符号，也有外部引用的符号，外部的符号没有大小，段信息，偏移等值。还有一些其他符号比如段名，文件名等，对于链接不重要所以不予分析。

|  内容  |  解释  |
| ---- | ---- |
|  st_name  |  符号名 |
|  st_size | 变量/函数大小 |
|  st_shndx | 符号所在的段 |
|  st_value | 符号所在的段中的偏移 |


## 查看目标文件构成的指令

1. 查看符号
nm hello.o